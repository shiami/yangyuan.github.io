---
layout: post
title: 为什么必须要写单元测试
---

以前知道 UT 好，但很惭愧，不爱写 UT。
在科学院上班的时候更是在回避 UT。（因为 Open Stack 本身是有 UT 的，我们二次开发改了逻辑，破坏了 UT，不想去修复）
只是有时写一些 Test 程序做 E2E 测试。

在贵软上班，稍微正经点的项目都是必写 UT 的。边写边吐，种种弊端还被拉慢 50% 的开发速度，跟我以往的节奏不太同，但也的确感受到的 UT 的好处，今天稍作总结。

好处
----
1. 发现 BUG。
最直观的好处，担心有 BUG，写一个 UT 试一遍，各种加 Assert，比眼睛看要准。
这些 Assert 只在 UT 中，不会破环实际产品的代码。

2. 阻止 BUG 再次发生。
发现了一个 BUG，修复之后，加一个 UT。以后只要保持每次提交代码，UT 都没有被 break，就保证了这个 BUG 没有被复现。

3. 阻止犯蠢。
程序员有很多经典的笑话，讲的是不要去碰年代久远系统。本想尝试去修复一个 BUG，或者做一个改进，然后世界崩塌了。
有足够多的 UT，只要这个 UT 没有 break，相信他的改动也不是那么灾难性的。

4. 学习代码参考。
维护文档本身是麻烦的，尤其是独立的文档，很容易过时。
一个常见的思路就是注释当文档。但注释文档往往只能解释代码本身，如果对不同的数据都一一做文档，注释会很长。
所以另一个办法就是写 UT，然后每个 UT 可以加一个叫解释：“输入是这个的时候，输出是这样的”。

5. 监控环境变化。
实际编程时候，会有很多假设，特别是在使用第三方库的时候。
比如：假设“这个函数不会返回空”，尽管你编程的时候是这样的，但几个月更新的时候，就不一定还是那样了。
写几个针对第三方的库的 UT，某一天这个 UT break 的时候，就提醒你有可能有潜在 BUG 了。

6. 对松耦合的保证。
大家都知道松耦合的优势。但很多时候，很难把握。
写 UT 的时候，如果耦合度太高，一大表现就是 UT 无法写，或者说 UT 之间会互相影响。
这实际上是一个提醒，你写的东西是否过于耦合。

弊端以及如何回避
----

1. 拖慢进度
这是当然的。但从项目整体上来说，是有利的。
我们经常允许短时间内的 UT 缺失，特别是一些新模块。（新加一个模块，允许几天后甚至几周后再加 UT）

2. 环境依赖
实际程序可能会在一个特殊的环境下允许的，比如特殊的网络，特殊的 Run Time 之类。
一般的做法是把这些特殊的东西用一个 Interface 包装起来，UT 的时候使用一个 Mock(Fake) 的 Interface。或者另一个思路，你的代码愿意接收一个插件式的 Interface，然后再 UT 的时候 Hook 进一个特制的实现。
这些 Mock/Fake/Hook 通常并不完全准确，但好在是可以复用的。
